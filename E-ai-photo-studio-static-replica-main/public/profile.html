<!-- /public/profile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Account · AI Photo Studio</title>
  <meta name="theme-color" content="#4f46e5"/>
  <link rel="manifest" href="/manifest.webmanifest"/>
  <style>
    body{margin:0;font-family:system-ui;background:#0b1220;color:#e5e7eb}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(148,163,184,.2);background:rgba(2,6,23,.7);backdrop-filter:blur(10px)}
    nav a{color:#e5e7eb;text-decoration:none;margin-left:12px}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:rgba(15,23,42,.92);border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:18px}
    .badge{display:inline-block;margin-top:8px;padding:6px 12px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid rgba(148,163,184,.45)}
    .pro{color:#4ade80;border-color:rgba(34,197,94,.7);background:rgba(22,163,74,.12)}
    .trial{color:#a5b4fc;border-color:rgba(129,140,248,.7);background:rgba(129,140,248,.12)}
    .free{color:#e5e7eb;background:rgba(148,163,184,.12)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #475569;background:#0b1220;color:#e5e7eb;cursor:pointer;font-weight:700;margin-top:10px;text-decoration:none}
    .primary{background:linear-gradient(135deg,#6366f1,#22c55e);border:none}
    .danger{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.6);color:#fecaca}
  </style>
  <script type="module" src="/auth.js"></script>
</head>
<body>
  <header>
    <div><a href="/index.html">Editor</a> · <a href="/gallery.html">Gallery</a> · <strong>Account</strong></div>
    <nav><a href="/signin.html">Sign in</a></nav>
  </header>

  <div class="wrap">
    <section class="card">
      <h2 style="margin:0 0 6px">Account Overview</h2>
      <span id="planPill" class="badge free">Checking…</span>
      <div style="margin-top:12px">Email</div><div id="email" style="margin:6px 0 0">—</div>
      <div style="margin-top:12px">Name</div><div id="name" style="margin:6px 0 0">—</div>
      <div style="margin-top:12px">Plan</div><div id="planBadge" class="badge free">Free</div>
      <p id="summary" style="color:#9ca3af;margin:8px 0 0">Loading…</p>
      <button id="btnTrial" class="btn primary">Start 7-Day Free Trial</button>
      <button id="btnUpgrade" class="btn">Upgrade to Pro</button>
      <button id="btnManage" class="btn">Manage billing</button>
      <button id="btnLogout" class="btn danger">Sign out</button>
    </section>
  </div>

  <script type="module">
    import { requireAuth, getUser, getServerPlan, signOut, startCheckout, openBillingPortal } from '/auth.js';
    if (!requireAuth('/signin.html')) throw new Error('no-auth');

    const u = getUser();
    document.getElementById('email').textContent = u?.email || '—';
    document.getElementById('name').textContent  = u?.name  || '—';

    const planKey = (sub)=>`aips.plan.${sub}`;
    function getPlan(sub){ try{ const raw=localStorage.getItem(planKey(sub)); return raw? JSON.parse(raw):{}; }catch{ return {}; } }
    function setPlan(sub,data){ localStorage.setItem(planKey(sub), JSON.stringify(data||{})); }

    function renderPlan(){
      const p = getServerPlan();
      const local = getPlan(u.sub);
      const activeTrial = local.trialEnds && local.trialEnds > Date.now();
      const pill = document.getElementById('planPill');
      const badge= document.getElementById('planBadge');
      const sum  = document.getElementById('summary');
      if (p.pro){
        pill.className='badge pro'; pill.textContent='PRO ACTIVE';
        badge.className='badge pro'; badge.textContent='Pro (server verified)';
        sum.textContent='Subscription active via Stripe.';
      } else if (activeTrial){
        pill.className='badge trial'; pill.textContent='TRIAL ACTIVE';
        const days=Math.max(1,Math.ceil((local.trialEnds-Date.now())/86400000));
        badge.className='badge trial'; badge.textContent=`Trial · ${days} day${days===1?'':'s'} left`;
        sum.textContent='Trial enables HD locally on this device.';
      } else {
        pill.className='badge free'; pill.textContent='FREE PLAN';
        badge.className='badge free'; badge.textContent='Free';
        sum.textContent='Upgrade to Pro to unlock HD everywhere.';
      }
    }
    renderPlan();

    document.getElementById('btnTrial').onclick = () => {
      const cur = getPlan(u.sub);
      if (cur.trialEnds && cur.trialEnds > Date.now()) { alert('Trial already active.'); return; }
      setPlan(u.sub, { ...cur, trialEnds: Date.now()+7*864e5 });
      alert('✅ 7-day trial started'); renderPlan();
    };
    document.getElementById('btnUpgrade').onclick = async () => { try{ await startCheckout(); }catch(e){ alert(e.message);} };
    document.getElementById('btnManage').onclick  = async () => { try{ await openBillingPortal(); }catch(e){ alert(e.message);} };
    document.getElementById('btnLogout').onclick  = () => signOut().then(()=>location.replace('/signin.html'));
  </script>
</body>
</html>
