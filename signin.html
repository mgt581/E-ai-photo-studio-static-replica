<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign in · AI Photo Studio</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Roboto,Arial,sans-serif;background:#f9fafb;display:flex;justify-content:center;align-items:center;height:100vh}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:32px;width:100%;max-width:400px;box-shadow:0 8px 24px rgba(0,0,0,.05);text-align:center}
    .logo{width:50px;height:50px;margin:0 auto 12px}
    h1{margin:0;font-size:22px;font-weight:700;color:#111827}
    p.sub{margin:4px 0 20px;font-size:14px;color:#6b7280}
    .social{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
    .sbtn{flex:1;border:1px solid #d1d5db;border-radius:8px;height:44px;display:flex;align-items:center;justify-content:center;background:#fff;cursor:pointer;font-weight:500}
    .field{text-align:left;margin-bottom:14px}
    .field label{display:block;font-size:13px;color:#374151;margin-bottom:4px}
    .field input{width:100%;height:44px;border:1px solid #d1d5db;border-radius:8px;padding:0 12px;font-size:14px}
    .actions{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin-bottom:14px}
    .actions a{color:#4f46e5;text-decoration:none}
    .btn-primary{width:100%;height:46px;border:none;border-radius:8px;background:#111827;color:#fff;font-weight:600;cursor:pointer;margin-bottom:14px}
    .footer{font-size:13px;color:#6b7280}
    .footer a{color:#4f46e5;text-decoration:none}
    .error{color:#dc2626;font-size:13px;margin-top:6px;display:none}
  </style>
</head>
<body>
  <div class="card">
    <img src="/apple-touch-icon.png" class="logo" alt="Logo" />
    <h1>Welcome back</h1>
    <p class="sub">Please enter your details to sign in</p>

    <!-- Social sign-in -->
    <div class="social">
      <button id="btnGoogle" class="sbtn">Google</button>
    </div>

    <!-- Email/Password -->
    <div class="field">
      <label for="email">Your Email Address</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
    </div>
    <div class="field">
      <label for="password">Password</label>
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
    </div>
    <div class="actions">
      <label><input type="checkbox" id="remember" /> Remember me</label>
      <a href="#" id="forgotPassword">Forgot password?</a>
    </div>
    <button id="btnEmailSignIn" class="btn-primary">Sign in</button>
    <div id="emailError" class="error"></div>

    <div class="footer">
      Don’t have an account? <a href="#" id="btnEmailSignUp">Sign up</a>
    </div>
  </div>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDsBDuaZ_rl7ro63Fv5gPh37EwSkfh-NqM",
      authDomain: "aiphotostudioapp.firebaseapp.com",
      projectId: "aiphotostudioapp",
      storageBucket: "aiphotostudioapp.appspot.com",
      messagingSenderId: "1056724519182",
      appId: "1:1056724519182:web:93410e1b71a292e531ef5f",
      measurementId: "G-YMB9JJHNBE"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Redirect if already signed in
    auth.onAuthStateChanged(user => { if (user) location.replace('/'); });

    const $ = id => document.getElementById(id);
    const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;

    // Upsert /users/{uid} with profile + trial on first login
    async function upsertUserProfile(user, giveTrial=false){
      if (!user) return;
      const ref = db.collection('users').doc(user.uid);
      const snap = await ref.get();

      // Prepare fields
      const base = {
        displayName: user.displayName || "",
        email: user.email || "",
        photoURL: user.photoURL || "",
      };

      if (!snap.exists) {
        // First time we see this user → create profile + trial
        const now = new Date();
        const ends = new Date(now.getTime() + SEVEN_DAYS_MS);
        await ref.set({
          ...base,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tier: "free",
          trial: {
            startsAt: firebase.firestore.Timestamp.fromDate(now),
            endsAt: firebase.firestore.Timestamp.fromDate(ends)
          }
        }, { merge: true });
      } else {
        // Ensure profile fields exist; don't override trial/tier here
        await ref.set(base, { merge: true });
      }
    }

    function goHome(){ location.replace('/'); }

    // Handle Google sign-in
    $('btnGoogle').onclick = async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        if (/Mobi|Android/i.test(navigator.userAgent)) {
          await auth.signInWithRedirect(provider);
        } else {
          const cred = await auth.signInWithPopup(provider);
          await upsertUserProfile(cred.user, true);
          goHome();
        }
      } catch (e) {
        alert('Google sign-in failed: ' + e.message);
      }
    };

    // Handle redirect result (mobile)
    window.addEventListener('load', async () => {
      try {
        const res = await auth.getRedirectResult();
        if (res && res.user) {
          await upsertUserProfile(res.user, true);
          goHome();
        }
      } catch (e) {
        // ignore if no pending redirect
      }
    });

    // Email sign-in
    $('btnEmailSignIn').onclick = async () => {
      $('emailError').style.display = 'none';
      const email = $('email').value.trim();
      const pass  = $('password').value;
      if (!email || !pass) {
        $('emailError').textContent = 'Enter email and password.';
        $('emailError').style.display = 'block'; return;
      }
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        await upsertUserProfile(cred.user, false); // create doc if missing
        goHome();
      } catch(e) {
        $('emailError').textContent = e.message;
        $('emailError').style.display = 'block';
      }
    };

    // Email sign-up
    $('btnEmailSignUp').onclick = async (e) => {
      e.preventDefault();
      $('emailError').style.display = 'none';
      const email = $('email').value.trim();
      const pass  = $('password').value;
      if (!email || !pass) {
        $('emailError').textContent = 'Enter email and password.';
        $('emailError').style.display = 'block'; return;
      }
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await upsertUserProfile(cred.user, true); // includes trial
        try { await cred.user.sendEmailVerification(); } catch {}
        goHome();
      } catch(e) {
        $('emailError').textContent = e.message;
        $('emailError').style.display = 'block';
      }
    };

    // Reset password
    $('forgotPassword').onclick = async (e) => {
      e.preventDefault();
      const email = $('email').value.trim();
      if (!email) { alert('Enter your email first'); return; }
      try {
        await auth.sendPasswordResetEmail(email);
        alert('Password reset email sent.');
      } catch(err) { alert(err.message); }
    };
  </script>
</body>
</html>