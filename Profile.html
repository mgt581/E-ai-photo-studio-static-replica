<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Account · AI Photo Studio</title>

  <style>
    body{
      margin:0; 
      font-family:system-ui,-apple-system,Roboto,Arial;
      background:#f9fafb;
    }
    header{
      background:#111827;
      color:#fff;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header .brand{
      font-size:20px;
      font-weight:700;
      letter-spacing:.3px;
    }
    header a{
      color:#fff;
      text-decoration:none;
      margin-left:18px;
      font-weight:600;
    }
    .wrap{
      max-width:700px;
      margin:40px auto;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:32px;
      box-shadow:0 6px 20px rgba(0,0,0,.06);
    }
    h2{margin-top:0;font-size:26px;color:#111827}
    .label{font-size:14px;color:#6b7280;margin-bottom:4px}
    .value{font-size:16px;color:#111827;margin-bottom:16px}
    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:9999px;
      font-weight:700;
      font-size:12px;
      margin-bottom:16px;
    }
    .pro{background:#d1fae5;color:#065f46}
    .trial{background:#e0e7ff;color:#3730a3}
    .free{background:#fee2e2;color:#991b1b}

    .btn{
      display:inline-block;
      padding:10px 16px;
      background:#111827;
      color:#fff;
      font-weight:700;
      border:none;
      border-radius:8px;
      cursor:pointer;
      margin-top:10px;
      text-decoration:none;
    }
    .btn.logout{
      background:#991b1b;
      margin-top:20px;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsBDuaZ_rl7ro63Fv5gPh37EwSkfh-NqM",
      authDomain: "aiphotostudioapp.firebaseapp.com",
      projectId: "aiphotostudioapp",
      storageBucket: "aiphotostudioapp.appspot.com",
      messagingSenderId: "1056724519182",
      appId: "1:1056724519182:web:93410e1b71a292e531ef5f",
      measurementId: "G-YMB9JJHNBE"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>
</head>

<body>

<header>
  <div class="brand">AI Photo Studio</div>
  <nav>
    <a href="/">Home</a>
    <a href="/profile.html">My Account</a>
  </nav>
</header>

<div class="wrap">
  <h2>My Account</h2>

  <div id="userEmail" class="value">Loading…</div>
  <div id="planBadge"></div>

  <div class="label">Created</div>
  <div id="createdAt" class="value">—</div>

  <div class="label">Trial Status</div>
  <div id="trialStatus" class="value">—</div>

  <button id="btnStartTrial" class="btn" style="display:none;">Start 7-Day Free Trial</button>
  <a id="btnBuy" href="#" class="btn" style="display:none;">Buy Pro · £4.99/yr</a>

  <button id="btnLogout" class="btn logout">Sign Out</button>
</div>

<script>
  const STRIPE_LINK = "https://buy.stripe.com/eVq6oJ3wugiPcFJ7QGd3i02";

  const elEmail      = document.getElementById("userEmail");
  const elBadge      = document.getElementById("planBadge");
  const elCreated    = document.getElementById("createdAt");
  const elTrial      = document.getElementById("trialStatus");
  const btnTrial     = document.getElementById("btnStartTrial");
  const btnBuy       = document.getElementById("btnBuy");
  const btnLogout    = document.getElementById("btnLogout");

  // REDIRECT if not logged in
  auth.onAuthStateChanged(async user=>{
    if(!user){
      location.replace("/signin.html");
      return;
    }

    elEmail.textContent = user.email || "No email";

    // Load profile from Firestore
    const ref = db.collection("users").doc(user.uid);
    const snap = await ref.get();
    const d = snap.data() || {};

    // CREATED DATE
    if(d.createdAt?.toDate){
      const t = d.createdAt.toDate();
      elCreated.textContent = t.toDateString();
    }

    // PLAN BADGE
    let badgeHTML = "";
    if(d.isPro || d.tier === "pro"){
      badgeHTML = `<span class="badge pro">PRO USER</span>`;
    } else if (d.trial?.endsAt?.toMillis){
      const timeLeft = d.trial.endsAt.toMillis() - Date.now();
      if(timeLeft > 0){
        const days = Math.ceil(timeLeft / 86400000);
        badgeHTML = `<span class="badge trial">${days} days left (Trial)</span>`;
      } else {
        badgeHTML = `<span class="badge free">Trial Ended</span>`;
      }
    } else {
      badgeHTML = `<span class="badge free">FREE PLAN</span>`;
    }
    elBadge.innerHTML = badgeHTML;

    // TRIAL TEXT
    if(d.trial?.endsAt?.toMillis){
      const left = d.trial.endsAt.toMillis() - Date.now();
      if(left > 0){
        const days = Math.ceil(left / 86400000);
        elTrial.textContent = `${days} day(s) remaining`;
      } else {
        elTrial.textContent = "Expired";
      }
    } else {
      elTrial.textContent = "No active trial";
    }

    // BUTTONS VISIBILITY
    if(d.isPro || d.tier === "pro"){
      btnBuy.style.display = "none";
      btnTrial.style.display = "none";
    } 
    else if(d.trial?.endsAt?.toMillis && d.trial.endsAt.toMillis() > Date.now()){
      btnTrial.style.display = "none";
      btnBuy.style.display = "inline-block";
      btnBuy.href = STRIPE_LINK;
    }
    else {
      btnTrial.style.display = "inline-block";
      btnBuy.style.display = "inline-block";
      btnBuy.href = STRIPE_LINK;
    }
  });

  // START TRIAL
  btnTrial.onclick = async ()=>{
    const user = auth.currentUser;
    if(!user) return;

    const now = new Date();
    const end = new Date(now.getTime() + 7*24*60*60*1000);

    await db.collection("users")
      .doc(user.uid)
      .set({
        tier:"trial",
        trial:{
          startsAt: firebase.firestore.Timestamp.fromDate(now),
          endsAt:   firebase.firestore.Timestamp.fromDate(end)
        }
      },{merge:true});

    alert("7-day free trial started!");
    location.reload();
  };

  btnLogout.onclick = ()=> auth.signOut();
</script>

</body>
</html>
