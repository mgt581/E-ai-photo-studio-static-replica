<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Photo Studio</title>

<!-- On-device background removal (MediaPipe) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<!-- THEME -->
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --ring:#e9edf3;
    --g1:#6366f1; --g2:#7c3aed; --accent:#10b981; --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  /* Top bar */
  header{
    position:sticky;top:0;z-index:20;
    background:linear-gradient(180deg,#ffffff,rgba(255,255,255,.85));
    backdrop-filter:saturate(1.2) blur(8px);
    border-bottom:1px solid #eef1f6;
  }
  .nav{max-width:1100px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:36px;height:36px;border-radius:9px}
  .brand h1{margin:0;font-size:26px;font-weight:900;letter-spacing:.2px}
  .brand .sub{margin:0;color:var(--muted);font-size:13px}
  .right{display:flex;align-items:center;gap:12px}
  .pill{font-size:12px;font-weight:800;padding:6px 12px;border-radius:999px;background:#eef1ff;color:#3730a3}
  .btn-pro{
    appearance:none;border:0;border-radius:999px;
    padding:10px 16px;font-weight:900;color:#fff;cursor:pointer;
    background:linear-gradient(90deg,var(--g1),var(--g2));
    box-shadow:0 10px 24px rgba(99,102,241,.35);
  }

  /* Content */
  .container{max-width:980px;margin:0 auto;padding:22px 18px}
  .hero{text-align:center;padding:12px 4px 10px}
  .hero h2{margin:4px 0 6px;font-size:40px;font-weight:900;letter-spacing:.2px}
  .hero p{margin:0 auto;color:var(--muted);max-width:760px}

  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:var(--radius);
    box-shadow:0 10px 30px rgba(2,6,23,.06); padding:22px; margin:18px 0;
  }
  .upload-card{display:grid;place-items:center;text-align:center;padding:28px}
  .u-title{font-size:28px;font-weight:900;margin:6px 0}
  .u-sub{color:var(--muted);max-width:560px}

  .btn{
    appearance:none;border:0;border-radius:14px;padding:14px 22px;font-weight:900;color:#fff;
    background:linear-gradient(90deg,var(--g1),var(--g2));cursor:pointer;
    box-shadow:0 10px 24px rgba(99,102,241,.35); transition:transform .04s;
  }
  .btn:active{transform:translateY(1px)}
  .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
  .btn-ghost{background:#eef1ff;color:#3730a3}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  label{display:block;margin:8px 0}
  input[type="file"]{display:block}
  .switch{display:flex;align-items:center;gap:8px;color:#0f172a}

  canvas{
    display:block; margin:16px auto; border:1px solid var(--ring); background:#fff;
    max-width:100%; height:auto; border-radius:12px;
  }
  .note{font-size:13px;text-align:center;margin-top:8px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <img src="/logo-512.png" alt="logo">
      <div>
        <h1>AI Photo Studio</h1>
        <p class="sub">Professional photo editing with recommended tools & easy workflow management</p>
      </div>
    </div>
    <div class="right">
      <span id="planBadge" class="pill">Free plan</span>
      <!-- Keep for later when you add Stripe; for now, this is just a button -->
      <button id="proBtn" class="btn-pro">Pro plan ¬∑ ¬£4.99/yr ¬∑ 7-day trial</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Upload -->
  <section class="card upload-card">
    <h3 class="u-title">Upload Your Photo</h3>
    <p class="u-sub">Choose a photo from your device, then remove the background and place it on your own background.</p>
    <label class="btn">
      <input id="photoInput" type="file" accept="image/*" hidden>
      üì∑ Choose Photo
    </label>
    <p id="status" class="note">Waiting for an image‚Ä¶</p>
  </section>

  <!-- Actions -->
  <section class="card">
    <div class="row">
      <button id="btnRemove" class="btn">Remove Background (Free)</button>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="btn btn-ghost" style="cursor:pointer">
        <input id="bgInput" type="file" accept="image/*" hidden>
        üñºÔ∏è Choose Background (from device)
      </label>
      <button id="btnChangeBg" class="btn" disabled>Change Background</button>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="switch">
        <input type="checkbox" id="fitToggle" checked>
        Fit subject to background
      </label>
      <label class="switch">
        <input type="checkbox" id="shadowToggle" checked>
        Add soft shadow (blend)
      </label>
    </div>
    <canvas id="stage"></canvas>
    <div class="row">
      <button id="btnDownload" class="btn" disabled>Download PNG</button>
    </div>
    <p id="planNote" class="note">Free plan adds a light watermark.</p>
  </section>
</main>

<script>
  // -------------------- State & Elements --------------------
  const photoInput = document.getElementById('photoInput');
  const bgInput = document.getElementById('bgInput');
  const btnRemove = document.getElementById('btnRemove');
  const btnChangeBg = document.getElementById('btnChangeBg');
  const btnDownload = document.getElementById('btnDownload');
  const fitToggle = document.getElementById('fitToggle');
  const shadowToggle = document.getElementById('shadowToggle');
  const statusEl = document.getElementById('status');
  const planNote = document.getElementById('planNote');
  const planBadge = document.getElementById('planBadge');
  const proBtn = document.getElementById('proBtn');
  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  let sourceImg = null;
  let cutoutImg = null;
  let bgImg = null;
  let isPro = !!localStorage.getItem('studio_pro'); // keep for future Stripe hookup

  function updatePlanUI(){
    planBadge.textContent = isPro ? 'Pro active' : 'Free plan';
    planNote.textContent  = isPro ? 'Pro active ‚Äî no watermark.' : 'Free plan adds a light watermark.';
  }
  updatePlanUI();

  // For now, just toggle local (no popup spam)
  proBtn.addEventListener('click', ()=>{
    isPro = !isPro;
    if(isPro) localStorage.setItem('studio_pro', '1'); else localStorage.removeItem('studio_pro');
    updatePlanUI();
  });

  // -------------------- MediaPipe Selfie Segmentation --------------------
  const selfieSegmentation = new SelfieSegmentation({
    locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
  });
  selfieSegmentation.setOptions({ modelSelection: 1 }); // best for photos
  selfieSegmentation.onResults(onSegmentation);

  function fileToImage(file){
    return new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=> res(img);
      img.onerror = rej;
      img.src = URL.createObjectURL(file);
    });
  }

  // -------------------- Upload Photo --------------------
  photoInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    sourceImg = await fileToImage(file);
    canvas.width = sourceImg.width;
    canvas.height = sourceImg.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(sourceImg,0,0,canvas.width,canvas.height);
    statusEl.textContent = "Photo loaded. Tap ‚ÄòRemove Background‚Äô.";
    btnDownload.disabled = false;
  });

  // -------------------- Remove Background (Free, on-device) --------------------
  btnRemove.addEventListener('click', async ()=>{
    if(!sourceImg){ alert("Upload a photo first."); return; }
    statusEl.textContent = "Removing background‚Ä¶";
    await selfieSegmentation.send({ image: sourceImg });
  });

  function onSegmentation(results){
    if(!results.segmentationMask){ statusEl.textContent = "Remove BG failed."; return; }

    // Offscreen canvas to build a smooth matte (threshold + feather)
    const w = sourceImg.width, h = sourceImg.height;

    // 1) Start with the raw mask
    const maskCanvas = document.createElement('canvas');
    maskCanvas.width = w; maskCanvas.height = h;
    const mctx = maskCanvas.getContext('2d');
    mctx.drawImage(results.segmentationMask, 0, 0, w, h);

    // 2) Threshold the mask to remove grey halos, then feather edges
    const maskData = mctx.getImageData(0,0,w,h);
    const d = maskData.data;
    for(let i=0;i<d.length;i+=4){
      // Use green channel from mask (MediaPipe writes grayscale into all channels)
      const v = d[i]; // 0..255
      const hard = v > 140 ? 255 : 0; // threshold (~0.55)
      d[i]=d[i+1]=d[i+2]=255;  // white matte
      d[i+3]=hard;             // hard alpha before feather
    }
    mctx.putImageData(maskData,0,0);
    // Feather the hard edges (soft hair)
    mctx.globalCompositeOperation='source-over';
    mctx.filter='blur(10px)';
    mctx.drawImage(maskCanvas,0,0);
    mctx.filter='none';

    // 3) Apply matte to original (destination-in keeps only where mask alpha)
    const off = document.createElement('canvas');
    off.width = w; off.height = h;
    const octx = off.getContext('2d');
    octx.drawImage(sourceImg,0,0,w,h);
    octx.globalCompositeOperation = 'destination-in';
    octx.drawImage(maskCanvas,0,0,w,h);
    octx.globalCompositeOperation = 'source-over';

    // 4) Save cutout
    cutoutImg = new Image();
    cutoutImg.src = off.toDataURL('image/png');
    cutoutImg.onload = ()=>{
      canvas.width = cutoutImg.width; canvas.height = cutoutImg.height;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // Optional soft shadow so subject doesn't look sticker-flat
      if (shadowToggle.checked){
        ctx.save();
        ctx.filter = 'blur(12px)';
        ctx.globalAlpha = 0.20;
        ctx.drawImage(cutoutImg, 6, 12, canvas.width, canvas.height);
        ctx.restore();
      }
      ctx.drawImage(cutoutImg,0,0,canvas.width,canvas.height);
      statusEl.textContent = "Background removed. Choose a background, then press ‚ÄòChange Background‚Äô.";
      btnChangeBg.disabled = !bgImg;
      btnDownload.disabled = false;
    };
  }

  // -------------------- Choose Background & Change --------------------
  bgInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    bgImg = await fileToImage(file);
    statusEl.textContent = "Background selected.";
    btnChangeBg.disabled = !cutoutImg;
  });

  btnChangeBg.addEventListener('click', ()=>{
    if(!cutoutImg){ alert("Remove background first."); return; }
    if(!bgImg){ alert("Choose a background image first."); return; }

    canvas.width = bgImg.width;
    canvas.height = bgImg.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Draw background
    ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

    // Place subject
    if(fitToggle.checked){
      const s=Math.min(canvas.width/cutoutImg.width, canvas.height/cutoutImg.height);
      const w=cutoutImg.width*s, h=cutoutImg.height*s;
      const x=(canvas.width-w)/2, y=(canvas.height-h)/2;

      // optional shadow on composite
      if (shadowToggle.checked){
        ctx.save(); ctx.filter='blur(10px)'; ctx.globalAlpha=.20;
        ctx.drawImage(cutoutImg, x+6, y+12, w, h);
        ctx.restore();
      }
      ctx.drawImage(cutoutImg,x,y,w,h);
    }else{
      const x=(canvas.width-cutoutImg.width)/2, y=(canvas.height-cutoutImg.height)/2;
      if (shadowToggle.checked){
        ctx.save(); ctx.filter='blur(10px)'; ctx.globalAlpha=.20;
        ctx.drawImage(cutoutImg, x+6, y+12);
        ctx.restore();
      }
      ctx.drawImage(cutoutImg,x,y);
    }

    statusEl.textContent = "Background changed. You can download now.";
    btnDownload.disabled = false;
  });

  // -------------------- Download (watermark on Free) --------------------
  btnDownload.addEventListener('click', ()=>{
    if(!isPro){
      ctx.save();
      ctx.globalAlpha = .22;
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(-0.6);
      ctx.fillStyle = '#111';
      ctx.font = `${Math.max(24,Math.floor(canvas.width*0.035))}px Inter,system-ui,sans-serif`;
      ctx.textAlign = 'center';
      ctx.fillText('AI Photo Studio ‚Äî FREE', 0, 0);
      ctx.restore();
    }
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'photo-studio.png';
    a.click();
  });
</script>
</body>
</html>
