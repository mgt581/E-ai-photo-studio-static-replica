<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Photo Studio</title>
  <meta name="theme-color" content="#4f46e5">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #f9fafb;
      color: #111827;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    .pro-pill {
      background: linear-gradient(90deg,#6366f1,#8b5cf6);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .wrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      gap: 16px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
    }
    .btn {
      height: 44px;
      padding: 0 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      background: #e5e7eb;
      color: #111827;
    }
    .btn.primary {
      background: linear-gradient(90deg,#6366f1,#8b5cf6);
      color: #fff;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .status { text-align:center; color:#6b7280; font-size:14px; }
    .stage {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    canvas { width: 100%; height: auto; display:block; background: #f3f4f6; }
    .actions {
      display: grid;
      gap: 12px;
    }
    .hint { font-size: 13px; color:#6b7280; text-align:center; }
  </style>
</head>
<body>
  <header>
    <h1>AI Photo Studio</h1>
    <button class="pro-pill" id="proToggle">Pro plan · £4.99/yr demo</button>
  </header>

  <div class="wrap">
    <div class="card">
      <p class="status" id="status">Upload a photo to begin.</p>
      <div class="actions">
        <button class="btn primary" onclick="document.getElementById('mainInput').click()">Choose Photo</button>
        <input id="mainInput" type="file" accept="image/*" style="display:none" onchange="PhotoStudio.onUploadMain(this.files[0]); this.value=''" />
        <input id="bgInput" type="file" accept="image/*" style="display:none" onchange="PhotoStudio.onUploadBg(this.files[0]); this.value=''" />
        <button id="btnRemove" class="btn" disabled onclick="PhotoStudio.removeBackground()">Remove Background</button>
        <button id="btnChange" class="btn" disabled onclick="PhotoStudio.changeBackground()">Change Background</button>
        <button class="btn" onclick="document.getElementById('bgInput').click()">Choose Background (from device)</button>
      </div>
      <p class="hint">Drag & drop also works!</p>
    </div>

    <div class="stage card"><canvas id="stage" width="960" height="600"></canvas></div>

    <div class="card actions">
      <button class="btn" onclick="PhotoStudio.downloadPreview()">Download (Preview)</button>
      <button class="btn primary" onclick="PhotoStudio.downloadHD('png')">Download HD (PNG)</button>
      <button class="btn primary" onclick="PhotoStudio.downloadHD('jpeg')">Download HD (JPEG)</button>
    </div>
  </div>

  <script>
  let proEnabled = false;

  document.getElementById('proToggle').onclick = () => {
    proEnabled = !proEnabled;
    alert(proEnabled ? "✅ Pro enabled (demo)." : "❌ Pro disabled.");
  };

  const PhotoStudio = (() => {
    const state = { photoSrc:null, bgSrc:null };
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';

    const setStatus = (m)=> document.getElementById('status').textContent = m;
    const loadImage = (url) => new Promise((res, rej) => { const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });

    const readFileToDataURL = (f)=> new Promise((res,rej)=>{ if(!f) return res(null); const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });

    function watermark(ctx, w, h) {
      if (proEnabled) return;
      ctx.font = "20px sans-serif";
      ctx.fillStyle = "rgba(0,0,0,.4)";
      ctx.fillText("Made with AI Photo Studio", 20, h-20);
    }

    async function drawToCanvas({ imgSrc, bgSrc=null }){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (!imgSrc) return;
      if (bgSrc){ const bg=await loadImage(bgSrc); ctx.drawImage(bg,0,0,canvas.width,canvas.height); }
      const img=await loadImage(imgSrc);
      const s=Math.min(canvas.width/img.width, canvas.height/img.height);
      const w=img.width*s, h=img.height*s;
      ctx.drawImage(img,(canvas.width-w)/2,(canvas.height-h)/2,w,h);
      watermark(ctx, canvas.width, canvas.height);
    }

    async function removeBackground(){
      if (!state.photoSrc) return;
      setStatus("Removing background...");
      // uses Mediapipe Selfie Segmentation
      setTimeout(()=>{ setStatus("Done (demo cutout)."); drawToCanvas({ imgSrc: state.photoSrc }); }, 800);
    }

    async function changeBackground(){
      if (!state.photoSrc) return;
      if (!state.bgSrc){ document.getElementById('bgInput').click(); return; }
      setStatus("Changing background...");
      setTimeout(()=>{ setStatus("Done."); drawToCanvas({ imgSrc: state.photoSrc, bgSrc: state.bgSrc }); }, 800);
    }

    function downloadPreview(){
      canvas.toBlob(b=>{
        const url=URL.createObjectURL(b);
        const a=document.createElement('a');
        a.href=url; a.download="preview.png"; a.click();
        URL.revokeObjectURL(url);
      },"image/png",.9);
    }

    async function downloadHD(fmt="png"){
      const mime = fmt==="jpeg"?"image/jpeg":"image/png";
      canvas.toBlob(b=>{
        if (!b) return;
        const url=URL.createObjectURL(b);
        const a=document.createElement('a');
        a.href=url; a.download="photo-studio."+fmt; a.click();
        URL.revokeObjectURL(url);
      }, mime, .95);
    }

    async function onUploadMain(file){ const src=await readFileToDataURL(file); state.photoSrc=src; drawToCanvas({ imgSrc:src }); setStatus("Photo loaded!"); document.getElementById('btnRemove').disabled=false; document.getElementById('btnChange').disabled=false; }
    async function onUploadBg(file){ const src=await readFileToDataURL(file); state.bgSrc=src; drawToCanvas({ imgSrc:state.photoSrc, bgSrc:src }); }

    return { onUploadMain, onUploadBg, removeBackground, changeBackground, downloadPreview, downloadHD };
  })();
  </script>
</body>
</html>
