<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Photo Studio</title>

  <!-- MediaPipe Selfie Segmentation -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

  <!-- Firebase (for sign in / sign up / pro plan) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body{margin:0;font-family:sans-serif;background:#f8fafc;color:#111}
    header{text-align:center;padding:20px}
    header h1{font-size:40px;margin:0}
    header p{color:#555}
    .card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:20px;margin:20px auto;max-width:600px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    .btn{padding:12px 20px;border:none;border-radius:8px;color:#fff;background:#4f46e5;cursor:pointer;margin:5px;font-weight:bold}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    canvas{display:block;margin:20px auto;border:1px solid #ccc;max-width:100%}
    .muted{color:#777}
  </style>
</head>
<body>
  <header>
    <h1>AI Photo Studio</h1>
    <p>Professional photo editing with easy workflow tools</p>
  </header>

  <div class="card">
    <p id="status" class="muted">Upload a photo to begin</p>
    <input type="file" id="photoInput" accept="image/*"><br>
    <button id="btnRemove" class="btn" disabled>Remove Background</button><br>
    <input type="file" id="bgInput" accept="image/*"><br>
    <label><input type="checkbox" id="fitToggle" checked> Fit subject to background</label><br>
    <button id="btnComposite" class="btn" disabled>Apply Background</button><br>
    <button id="btnDownload" class="btn" disabled>Download Result</button>
    <canvas id="stage"></canvas>
  </div>

  <div class="card">
    <h3>Pro Plan</h3>
    <button id="btnUpgrade" class="btn">Upgrade to Pro</button>
    <button id="btnSignOut" class="btn" style="display:none">Sign Out</button>
    <p id="authStatus" class="muted">Not signed in</p>
  </div>

  <script>
    // Firebase demo config (replace with your own if needed)
    const firebaseConfig = {
      apiKey: "AIzaSyXXXX",
      authDomain: "aiphotostudioapp.firebaseapp.com",
      projectId: "aiphotostudioapp"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Elements
    const statusEl=document.getElementById('status');
    const photoInput=document.getElementById('photoInput');
    const bgInput=document.getElementById('bgInput');
    const btnRemove=document.getElementById('btnRemove');
    const btnComposite=document.getElementById('btnComposite');
    const btnDownload=document.getElementById('btnDownload');
    const btnUpgrade=document.getElementById('btnUpgrade');
    const btnSignOut=document.getElementById('btnSignOut');
    const authStatus=document.getElementById('authStatus');
    const fitToggle=document.getElementById('fitToggle');
    const canvas=document.getElementById('stage');
    const ctx=canvas.getContext('2d');

    let sourceImg=null, cutoutImg=null, bgImg=null;
    let isPro=false;

    // MediaPipe setup
    const selfieSegmentation = new SelfieSegmentation({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
    selfieSegmentation.setOptions({modelSelection:1});
    selfieSegmentation.onResults(onResults);

    function fileToImage(file){
      return new Promise((res,rej)=>{
        const img=new Image();
        img.onload=()=>res(img);
        img.onerror=rej;
        img.src=URL.createObjectURL(file);
      });
    }

    photoInput.onchange=async e=>{
      const file=e.target.files[0];
      if(!file)return;
      sourceImg=await fileToImage(file);
      canvas.width=sourceImg.width;
      canvas.height=sourceImg.height;
      ctx.drawImage(sourceImg,0,0,canvas.width,canvas.height);
      statusEl.textContent="Photo loaded!";
      btnRemove.disabled=false;
      btnDownload.disabled=false;
    };

    function onResults(results){
      if(!results.segmentationMask)return;
      canvas.width=sourceImg.width;
      canvas.height=sourceImg.height;
      ctx.drawImage(results.segmentationMask,0,0,canvas.width,canvas.height);
      ctx.globalCompositeOperation='source-in';
      ctx.drawImage(sourceImg,0,0,canvas.width,canvas.height);
      ctx.globalCompositeOperation='source-over';
      cutoutImg=new Image();
      cutoutImg.src=canvas.toDataURL();
      statusEl.textContent="Background removed!";
      btnComposite.disabled=!(!bgInput.files[0]);
    }

    btnRemove.onclick=()=>{
      if(sourceImg){
        selfieSegmentation.send({image:sourceImg});
      }
    };

    bgInput.onchange=async e=>{
      const file=e.target.files[0];
      if(!file)return;
      bgImg=await fileToImage(file);
      statusEl.textContent="Background selected.";
      btnComposite.disabled=!(!cutoutImg);
    };

    btnComposite.onclick=()=>{
      if(!cutoutImg||!bgImg)return;
      canvas.width=bgImg.width;
      canvas.height=bgImg.height;
      ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);
      if(fitToggle.checked){
        const scale=Math.min(canvas.width/cutoutImg.width,canvas.height/cutoutImg.height);
        const w=cutoutImg.width*scale,h=cutoutImg.height*scale;
        const x=(canvas.width-w)/2,y=(canvas.height-h)/2;
        ctx.drawImage(cutoutImg,x,y,w,h);
      }else{
        const x=(canvas.width-cutoutImg.width)/2,y=(canvas.height-cutoutImg.height)/2;
        ctx.drawImage(cutoutImg,x,y);
      }
      statusEl.textContent="Background applied!";
    };

    btnDownload.onclick=()=>{
      const a=document.createElement('a');
      a.href=canvas.toDataURL("image/png");
      a.download="photo.png";
      if(!isPro){
        // apply watermark
        ctx.font="28px sans-serif";
        ctx.fillStyle="rgba(255,0,0,0.5)";
        ctx.fillText("AI Photo Studio FREE",20,40);
        a.href=canvas.toDataURL("image/png");
      }
      a.click();
    };

    btnUpgrade.onclick=()=>{
      isPro=true;alert("Pro mode enabled (demo). Add Stripe to make real.");
    };

    // Firebase Auth (demo)
    auth.onAuthStateChanged(user=>{
      if(user){
        authStatus.textContent="Signed in: "+(user.email||"Guest");
        btnSignOut.style.display="inline-block";
      }else{
        authStatus.textContent="Not signed in";
        btnSignOut.style.display="none";
      }
    });
    btnSignOut.onclick=()=>auth.signOut();
  </script>
</body>
</html>
