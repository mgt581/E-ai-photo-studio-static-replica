<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Photo Studio</title>

<!-- MediaPipe Selfie Segmentation ‚Äì browser ready -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#667085; --ring:#e5e7eb;
    --g1:#6366f1; --g2:#7c3aed; --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff,rgba(255,255,255,.75));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #eef0f5;z-index:10}
  .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:26px;margin:0;font-weight:800;letter-spacing:.2px}
  .tag{color:var(--muted);font-size:13px}
  .probtn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:999px;padding:10px 14px;color:#fff;background:linear-gradient(90deg,var(--g1),var(--g2));font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(99,102,241,.35)}
  .container{max-width:980px;margin:0 auto;padding:22px 18px}
  .hero{padding:12px 4px 22px;text-align:center}
  .hero h2{font-size:40px;margin:6px 0 6px;font-weight:900}
  .hero p{color:var(--muted);margin:0 auto;max-width:760px}

  .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:0 8px 28px rgba(2,6,23,.06);padding:22px;margin:18px 0}
  .upload-card{display:grid;place-items:center;text-align:center;padding:28px}
  .u-title{font-size:28px;font-weight:900;margin:6px 0}
  .u-sub{color:var(--muted);max-width:520px}
  .btn{appearance:none;border:0;border-radius:14px;padding:14px 22px;font-weight:800;color:#fff;background:linear-gradient(90deg,var(--g1),var(--g2));cursor:pointer;box-shadow:0 10px 24px rgba(99,102,241,.35)}
  .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
  .ghost{background:#eef1ff;color:#3730a3}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  label{display:block;margin:8px 0}
  input[type="file"]{display:block}
  canvas{display:block;margin:16px auto;border:1px solid var(--ring);background:#fff;max-width:100%;height:auto;border-radius:12px}
  .switch{display:flex;align-items:center;gap:8px;color:#0f172a}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand">
      <img src="/logo-512.png" alt="logo" style="width:36px;height:36px;border-radius:9px">
      <div>
        <h1>AI Photo Studio</h1>
        <div class="tag">Professional photo editing with recommended tools & easy workflow management</div>
      </div>
    </div>

    <!-- Pro plan button (top-right) -->
    <button id="btnPro" class="probtn">Pro plan ¬∑ ¬£4.99/yr <span class="tag" style="color:#e9e7ff;opacity:.9">7-day trial</span></button>
  </div>
</header>

<main class="container">
  <!-- Upload -->
  <section class="card upload-card">
    <h3 class="u-title">Upload Your Photo</h3>
    <p class="u-sub">Drag & drop or choose a photo from your device.</p>
    <label class="btn">
      <input id="photoInput" type="file" accept="image/*" hidden>
      üì∑ Choose Photo
    </label>
    <p id="status" class="muted" style="margin:12px 0 0">Waiting for an image‚Ä¶</p>
  </section>

  <!-- Actions -->
  <section class="card">
    <div class="row" style="justify-content:center">
      <button id="btnRemove" class="btn" disabled>Remove Background</button>
      <label class="btn ghost" style="cursor:pointer">
        <input id="bgInput" type="file" accept="image/*" hidden>
        üñºÔ∏è Choose Background (from device)
      </label>
      <button id="btnChangeBg" class="btn" disabled>Change Background</button>
    </div>
    <div class="row" style="justify-content:center;margin-top:8px">
      <label class="switch">
        <input type="checkbox" id="fitToggle" checked>
        Fit subject to background
      </label>
    </div>
    <canvas id="stage"></canvas>
    <div class="row" style="justify-content:center">
      <button id="btnDownload" class="btn" disabled>Download PNG</button>
    </div>
    <p id="note" class="muted" style="text-align:center;margin:8px 0 0">Free plan adds a light watermark.</p>
  </section>
</main>

<script>
  // ======= Elements / State =======
  const photoInput = document.getElementById('photoInput');
  const bgInput = document.getElementById('bgInput');
  const btnRemove = document.getElementById('btnRemove');
  const btnChangeBg = document.getElementById('btnChangeBg');
  const btnDownload = document.getElementById('btnDownload');
  const fitToggle = document.getElementById('fitToggle');
  const statusEl = document.getElementById('status');
  const btnPro = document.getElementById('btnPro');
  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  let sourceImg = null;   // uploaded original
  let cutoutImg = null;   // transparent bg
  let bgImg = null;       // chosen background
  let isPro = !!localStorage.getItem('studio_pro');

  // Update Pro button / note
  function updateProUI(){
    btnPro.textContent = isPro ? "Pro active ‚úÖ" : "Pro plan ¬∑ ¬£4.99/yr  7-day trial";
    document.getElementById('note').textContent = isPro ? "Pro active ‚Äî no watermark." : "Free plan adds a light watermark.";
  }
  updateProUI();

  // ======= MediaPipe Selfie Segmentation setup =======
  const selfieSegmentation = new SelfieSegmentation({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
  });
  selfieSegmentation.setOptions({ modelSelection: 1 }); // 1 = landscape/portrait photos
  selfieSegmentation.onResults(onResults);

  function fileToImage(file){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  // ======= Upload main photo =======
  photoInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    sourceImg = await fileToImage(file);

    canvas.width = sourceImg.width;
    canvas.height = sourceImg.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(sourceImg, 0, 0, canvas.width, canvas.height);

    statusEl.textContent = "Photo loaded. Tap ‚ÄòRemove Background‚Äô.";
    btnRemove.disabled = false;
    btnDownload.disabled = false;
  });

  // ======= Remove BG (with feathered edges for nicer hair) =======
  btnRemove.addEventListener('click', async ()=>{
    if(!sourceImg){ alert("Upload a photo first."); return; }
    statusEl.textContent = "Removing background‚Ä¶";
    await selfieSegmentation.send({ image: sourceImg });
  });

  function onResults(results){
    if(!results.segmentationMask){ statusEl.textContent = "Remove BG failed."; return; }

    // Offscreen composition with feather (blur) on mask edges
    const off = document.createElement('canvas');
    off.width = sourceImg.width;
    off.height = sourceImg.height;
    const octx = off.getContext('2d');

    // Draw original
    octx.clearRect(0,0,off.width,off.height);
    octx.drawImage(sourceImg, 0, 0, off.width, off.height);

    // Use mask as alpha: destination-in keeps where mask is opaque
    octx.globalCompositeOperation = 'destination-in';
    // Feather the edge a bit to avoid harsh cut lines (improves hair)
    octx.filter = 'blur(6px)';
    octx.drawImage(results.segmentationMask, 0, 0, off.width, off.height);
    octx.filter = 'none';
    octx.globalCompositeOperation = 'source-over';

    // Save as image
    cutoutImg = new Image();
    cutoutImg.src = off.toDataURL('image/png');
    cutoutImg.onload = ()=>{
      canvas.width = cutoutImg.width;
      canvas.height = cutoutImg.height;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(cutoutImg, 0, 0, canvas.width, canvas.height);
      statusEl.textContent = "Background removed. Now choose a background and press ‚ÄòChange Background‚Äô.";
      btnChangeBg.disabled = !bgImg;
    };
  }

  // ======= Choose background from device =======
  bgInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    bgImg = await fileToImage(file);
    statusEl.textContent = "Background selected.";
    btnChangeBg.disabled = !cutoutImg;
  });

  // ======= Change Background =======
  btnChangeBg.addEventListener('click', ()=>{
    if(!cutoutImg){ alert("Remove background first."); return; }
    if(!bgImg){ alert("Choose a background image first."); return; }

    // Canvas matches background
    canvas.width = bgImg.width;
    canvas.height = bgImg.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Draw background
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

    // Place subject
    if(fitToggle.checked){
      const scale = Math.min(canvas.width / cutoutImg.width, canvas.height / cutoutImg.height);
      const w = cutoutImg.width * scale, h = cutoutImg.height * scale;
      const x = (canvas.width - w) / 2, y = (canvas.height - h) / 2;
      ctx.drawImage(cutoutImg, x, y, w, h);
    } else {
      const x = (canvas.width - cutoutImg.width) / 2, y = (canvas.height - cutoutImg.height) / 2;
      ctx.drawImage(cutoutImg, x, y);
    }

    statusEl.textContent = "Background changed. You can download now.";
    btnDownload.disabled = false;
  });

  // ======= Download (with watermark on Free) =======
  btnDownload.addEventListener('click', ()=>{
    if(!isPro){
      // add a tasteful diagonal watermark
      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(-Math.atan(canvas.height/canvas.width)); // slight diagonal
      ctx.fillStyle = '#111';
      ctx.font = `${Math.max(24, Math.floor(canvas.width*0.035))}px Inter, system-ui, sans-serif`;
      ctx.textAlign = 'center';
      ctx.fillText('AI Photo Studio ‚Äî FREE', 0, 0);
      ctx.restore();
    }
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'photo-studio.png';
    a.click();
  });

  // ======= Pro toggle (demo). Replace with Stripe later. =======
  btnPro.addEventListener('click', ()=>{
    // Demo: toggle pro locally. Replace with Stripe Checkout later.
    isPro = !isPro;
    if(isPro){ localStorage.setItem('studio_pro','1'); alert('Pro enabled ‚úÖ (demo).'); }
    else { localStorage.removeItem('studio_pro'); alert('Pro disabled.'); }
    updateProUI();
  });
</script>

</body>
</html>