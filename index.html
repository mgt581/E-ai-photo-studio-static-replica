<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Photo Studio</title>

  <!-- FREE client-side background remover -->
  <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@latest/dist/background-removal.min.js"></script>

  <style>
    :root { --primary: #4f46e5; --muted: #64748b; }
    body { margin:0; font-family:system-ui,sans-serif; background:#f8fafc; color:#0f172a; }
    .wrap{max-width:900px;margin:0 auto;padding:16px;}
    .hero{text-align:center;margin-bottom:20px;padding:28px 16px;}
    .brand-logo{width:72px;height:72px;border-radius:16px;}
    .brand-title{font-size:42px;font-weight:800;margin:16px 0 6px;}
    .tagline{color:#667085;max-width:680px;margin:0 auto;}
    .card{background:#fff;padding:16px;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:20px;}
    .button{background:var(--primary);color:#fff;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;margin:5px;}
    .button:disabled{background:#9ca3af;cursor:not-allowed;}
    .muted{color:var(--muted);}
    canvas{display:block;margin:20px auto;border:1px solid #ddd;max-width:100%;height:auto;}
    label{display:block;margin:8px 0;}
  </style>
</head>
<body>
  <header class="hero">
    <img src="/logo-512.png" alt="AI Photo Studio" class="brand-logo" />
    <h1 class="brand-title">AI Photo Studio</h1>
    <p class="tagline">Professional photo editing with easy background tools</p>
  </header>

  <div class="wrap">
    <div id="controls" class="card">
      <p id="status" class="muted">Upload a photo to begin</p>
      <label for="photoUpload">Select Photo</label>
      <input type="file" id="photoUpload" accept="image/*">

      <div>
        <button class="button" id="btnRemoveBg" disabled>Remove Background</button>
        <label for="bgUpload">Choose Your Own Background</label>
        <input type="file" id="bgUpload" accept="image/*">
        <button class="button" id="btnChangeBg" disabled>Change Background</button>
      </div>

      <!-- New toggle -->
      <label>
        <input type="checkbox" id="fitToggle" checked>
        Fit subject to background
      </label>

      <canvas id="main-canvas"></canvas>
      <button class="button" id="btnDownload" disabled>Download Result</button>
    </div>
  </div>

  <script>
    const photoUpload = document.getElementById('photoUpload');
    const bgUpload = document.getElementById('bgUpload');
    const btnRemoveBg = document.getElementById('btnRemoveBg');
    const btnChangeBg = document.getElementById('btnChangeBg');
    const btnDownload = document.getElementById('btnDownload');
    const statusEl = document.getElementById('status');
    const fitToggle = document.getElementById('fitToggle');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');

    let originalFile = null;
    let currentResultUrl = null;
    let bgFile = null;

    // Load main photo
    photoUpload.onchange = e => {
      originalFile = e.target.files[0];
      if (!originalFile) return;
      const img = new Image();
      img.src = URL.createObjectURL(originalFile);
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        statusEl.textContent = "Photo loaded!";
        btnRemoveBg.disabled = false;
      }
    };

    // Remove BG locally
    btnRemoveBg.onclick = async () => {
      if (!originalFile) return;
      statusEl.textContent = "Removing background...";

      const toBitmap = async file => {
        if ('createImageBitmap' in window) return await createImageBitmap(file);
        return await new Promise((res,rej)=>{
          const i=new Image();
          i.src=URL.createObjectURL(file);
          i.onload=()=>res(i); i.onerror=rej;
        });
      };

      const imgBitmap = await toBitmap(originalFile);
      try {
        const resultBlob = await removeBackground(imgBitmap, {
          model:"u2net", output:"image/png"
        });

        currentResultUrl = URL.createObjectURL(resultBlob);
        const cut = new Image();
        cut.src = currentResultUrl;
        cut.onload = () => {
          canvas.width = cut.width;
          canvas.height = cut.height;
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(cut,0,0,canvas.width,canvas.height);
          statusEl.textContent = "Background removed!";
          btnChangeBg.disabled = false;
          btnDownload.disabled = false;
        };
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Remove Background failed.";
        alert("Remove BG failed: " + err.message);
      }
    };

    // Pick custom background
    bgUpload.onchange = e => {
      bgFile = e.target.files[0] || null;
    };

    // Change BG with uploaded background
    btnChangeBg.onclick = async () => {
      if (!currentResultUrl || !bgFile) return alert("Upload a background first!");
      const fg = new Image(); fg.src = currentResultUrl;
      const bg = new Image(); bg.src = URL.createObjectURL(bgFile);

      await Promise.all([fg.decode?.(), bg.decode?.()]);

      // Resize canvas to match background
      canvas.width = bg.width;
      canvas.height = bg.height;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Draw background
      ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

      if (fitToggle.checked) {
        // Fit subject to background
        const scale = Math.min(canvas.width/fg.width, canvas.height/fg.height);
        const x = (canvas.width - fg.width*scale)/2;
        const y = (canvas.height - fg.height*scale)/2;
        ctx.drawImage(fg, x, y, fg.width*scale, fg.height*scale);
      } else {
        // Keep original subject size, center it
        const x = (canvas.width - fg.width)/2;
        const y = (canvas.height - fg.height)/2;
        ctx.drawImage(fg, x, y);
      }

      statusEl.textContent = "Background changed!";
    };

    // Download result
    btnDownload.onclick = () => {
      const link = document.createElement('a');
      link.href = canvas.toDataURL("image/png");
      link.download = "photo-studio.png";
      link.click();
    };
  </script>
</body>
</html>
